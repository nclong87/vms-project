----------------------------------------------------------  DDL for Function SAVE_TUYENKENH--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."SAVE_TUYENKENH" (id_ in VARCHAR2,diemdau_id_ in VARCHAR2,diemcuoi_id_ in VARCHAR2,giaotiep_id_ in VARCHAR2,duan_id_ in VARCHAR2,phongban_id_ in VARCHAR2,doitac_id_ in VARCHAR2,dungluong_ in VARCHAR2,soluong_ in VARCHAR2,trangthai_ in VARCHAR2,usercreate_ in VARCHAR2,timecreate_ in DATE,deleted_ in VARCHAR2,loaikenh_ in VARCHAR2) RETURN VARCHAR2 ASi INTEGER := 0;madoitac varchar2(50);matuyenkenh varchar2(20);vSotuyenkenh varchar2(20);BEGIN  if(id_ is not null) then --update    update TUYENKENH set MADIEMDAU=diemdau_id_,MADIEMCUOI=diemcuoi_id_, GIAOTIEP_ID=giaotiep_id_, DUAN_ID = duan_id_,PHONGBAN_ID = phongban_id_,DOITAC_ID = doitac_id_,DUNGLUONG = dungluong_,SOLUONG = soluong_,TRANGTHAI = trangthai_,LOAIKENH = loaikenh_ where ID = id_;    matuyenkenh := id_;    PROC_INSERT_LICHSU_TUYENKENH(usercreate_,matuyenkenh,3,'');  else --insert    select ma into madoitac from doitac where id = doitac_id_;    matuyenkenh := FN_GEN_MATUYENKENH(doitac_id_,madoitac);    insert into TUYENKENH(ID, MADIEMDAU, MADIEMCUOI, GIAOTIEP_ID, DUAN_ID, PHONGBAN_ID, DOITAC_ID, DUNGLUONG, SOLUONG, TRANGTHAI, USERCREATE, TIMECREATE, DELETED,LOAIKENH) values (matuyenkenh, diemdau_id_, diemcuoi_id_, giaotiep_id_, duan_id_, phongban_id_, doitac_id_, dungluong_, soluong_, trangthai_, usercreate_, timecreate_, 0,loaikenh_);    vSotuyenkenh :=  replace(matuyenkenh, madoitac||'_');    UPDATE DOITAC SET SOTUYENKENH = vSotuyenkenh WHERE ID = doitac_id_;    PROC_INSERT_LICHSU_TUYENKENH(usercreate_,matuyenkenh,1,'');  end if;  return matuyenkenh;END SAVE_TUYENKENH;/----------------------------------------------------------  DDL for Function FN_GEN_MATUYENKENH--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."FN_GEN_MATUYENKENH" (pDoiTacId in NUMBER,pMaDoiTac in varchar2) RETURN VARCHAR2 ASi NUMBER;vFlag BOOLEAN := true;vMaTuyenKenh VARCHAR2(50);vNumber NUMBER;BEGIN  i:=GET_SOTUYENKENH(pDoitacId) + 1;  while(vFlag) LOOP    vMaTuyenKenh := pMaDoiTac||'_'||TRIM(to_char(i,'0009'));    select count(*) INTO vNumber from TUYENKENH WHERE ID = vMaTuyenKenh;    if(vNumber > 0) then      --select count(*) into i from TUYENKENH where DOITAC_ID = pDoitacId;      --update DOITAC set SOTUYENKENH = i WHERE ID = pDoitacId;      --COMMIT;      i:=i+1;    else      vFlag := false;    end if;  END LOOP;  RETURN vMaTuyenKenh;END FN_GEN_MATUYENKENH;/----------------------------------------------------------  DDL for Procedure PROC_IMPORT_TUYENKENH--------------------------------------------------------set define off;  CREATE OR REPLACE PROCEDURE "THUEKENH"."PROC_IMPORT_TUYENKENH" (pi_array in TABLE_NUMBER,usercreate_ in varchar2,timecreate_ in date) ASi INTEGER := 1;madoitac varchar2(50);matuyenkenh varchar2(20);vSotuyenkenh varchar2(20);BEGIN  for rec in (SELECT t.ID,t.MADIEMDAU, t.MADIEMCUOI, t0.ID as GIAOTIEP_ID, t1.ID as DUAN_ID, t2.ID as PHONGBAN_ID, t3.ID as DOITAC_ID, t.DUNGLUONG, t.SOLUONG,DUPLICATE,DOITAC_MA,t.TRANGTHAI FROM TUYENKENH_IMPORT t left join LOAIGIAOTIEP t0 on t.GIAOTIEP_MA = t0.MA left join DUAN t1 on t.DUAN_MA = t1.MA left join PHONGBAN t2 on t.PHONGBAN_MA = t2.MA left join DOITAC t3 on t.DOITAC_MA=t3.MA where t.ID in (select * from table(pi_array))) loop    if(rec.DUPLICATE is not null) then --duplicate => update tuyenkenh      update TUYENKENH set MADIEMDAU = rec.MADIEMDAU, MADIEMCUOI = rec.MADIEMCUOI, GIAOTIEP_ID = rec.GIAOTIEP_ID, DUAN_ID = rec.DUAN_ID, PHONGBAN_ID = rec.PHONGBAN_ID, DOITAC_ID = rec.DOITAC_ID, DUNGLUONG = rec.DUNGLUONG, SOLUONG = rec.SOLUONG, TRANGTHAI = rec.TRANGTHAI where ID = rec.DUPLICATE;      delete from TUYENKENH_IMPORT where ID = rec.ID;    else --insert      matuyenkenh := FN_GEN_MATUYENKENH(rec.DOITAC_ID,rec.DOITAC_MA);      BEGIN        insert into TUYENKENH(ID,MADIEMDAU,MADIEMCUOI,GIAOTIEP_ID,DUAN_ID,PHONGBAN_ID,DOITAC_ID,DUNGLUONG,TRANGTHAI,USERCREATE,TIMECREATE,DELETED,SOLUONG,TRANGTHAI_BAK) values (matuyenkenh,rec.MADIEMDAU,rec.MADIEMCUOI,rec.GIAOTIEP_ID,rec.DUAN_ID,rec.PHONGBAN_ID,rec.DOITAC_ID,rec.DUNGLUONG,rec.TRANGTHAI,usercreate_,timecreate_,0,rec.SOLUONG,0);        vSotuyenkenh :=  replace(matuyenkenh, rec.DOITAC_MA||'_');        UPDATE DOITAC SET SOTUYENKENH = vSotuyenkenh WHERE ID = rec.DOITAC_ID;        --UPDATE DOITAC SET SOTUYENKENH = SOTUYENKENH + 1 WHERE ID = rec.DOITAC_ID;        delete from TUYENKENH_IMPORT where ID = rec.ID;      EXCEPTION WHEN OTHERS THEN        select ID into matuyenkenh from tuyenkenh where MADIEMDAU =rec.MADIEMDAU and MADIEMCUOI=rec.MADIEMCUOI and GIAOTIEP_ID=rec.GIAOTIEP_ID and DUNGLUONG=rec.DUNGLUONG;        update TUYENKENH_IMPORT set DUPLICATE = matuyenkenh WHERE ID = rec.ID;      END;    end if;  end loop;END PROC_IMPORT_TUYENKENH;/----------------------------------------------------------  DDL for Function SAVE_TUYENKENHDEXUAT--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."SAVE_TUYENKENHDEXUAT" (id_ in VARCHAR2,tuyenkenh_id_ in VARCHAR2,madiemdau_ in VARCHAR2,madiemcuoi_ in VARCHAR2,giaotiep_id_ in VARCHAR2,duan_id_ in VARCHAR2,phongban_id_ in VARCHAR2,doitac_id_ in VARCHAR2,dungluong_ in VARCHAR2,ngaydenghibangiao_ in VARCHAR2,ngayhenbangiao_ in VARCHAR2,thongtinlienhe_ in VARCHAR2,soluong_ in NUMBER,soluong_old in NUMBER,usercreate_ in VARCHAR2,timecreate_ in VARCHAR2,loaikenh_ in VARCHAR2) RETURN NUMBER ASi INTEGER := 0;madoitac varchar2(50);matuyenkenh varchar2(20);id_tuyenkenh varchar2(50);str varchar2(500) := '';vSotuyenkenh varchar2(20);BEGIN  if(tuyenkenh_id_ is not null) then --update    update TUYENKENH set DUAN_ID = duan_id_,PHONGBAN_ID = phongban_id_,DOITAC_ID = doitac_id_,DUNGLUONG = dungluong_,SOLUONG = SOLUONG + (soluong_ - soluong_old),TRANGTHAI_BAK = TRANGTHAI, TRANGTHAI = 2, LOAIKENH = loaikenh_  where ID = tuyenkenh_id_ and DELETED = 0;    id_tuyenkenh := tuyenkenh_id_;    PROC_INSERT_LICHSU_TUYENKENH(usercreate_,id_tuyenkenh,3,'');  else --insert    i:=GET_SOTUYENKENH(doitac_id_) + 1;    select ma into madoitac from doitac where id = doitac_id_;    id_tuyenkenh := FN_GEN_MATUYENKENH(doitac_id_,madoitac);    insert into TUYENKENH(ID, MADIEMDAU, MADIEMCUOI, GIAOTIEP_ID, DUAN_ID, PHONGBAN_ID, DOITAC_ID, DUNGLUONG, SOLUONG, TRANGTHAI, USERCREATE, TIMECREATE, DELETED,LOAIKENH) values (id_tuyenkenh, madiemdau_, madiemcuoi_, giaotiep_id_, duan_id_, phongban_id_, doitac_id_, dungluong_, soluong_, 1, usercreate_, timecreate_, 0,loaikenh_);    vSotuyenkenh :=  replace(id_tuyenkenh, madoitac||'_');    UPDATE DOITAC SET SOTUYENKENH = vSotuyenkenh WHERE ID = doitac_id_;    PROC_INSERT_LICHSU_TUYENKENH(usercreate_,id_tuyenkenh,1,'');  end if;  if(id_ is not null and id_>0) then --update    update TUYENKENHDEXUAT set TUYENKENH_ID = id_tuyenkenh,NGAYDENGHIBANGIAO = ngaydenghibangiao_,NGAYHENBANGIAO = ngayhenbangiao_,THONGTINLIENHE = thongtinlienhe_,SOLUONG = soluong_ where ID = id_;    i := id_;    str := '<root><element><id>'||i||'</id></element></root>';    PROC_INSERT_LICHSU_TUYENKENH(usercreate_,id_tuyenkenh,8,str);  else --insert    i:=SEQ_TUYENKENHDEXUAT.nextval;    insert into TUYENKENHDEXUAT(ID, DEXUAT_ID, TUYENKENH_ID, BANGIAO_ID, NGAYDENGHIBANGIAO, NGAYHENBANGIAO, THONGTINLIENHE, TRANGTHAI, SOLUONG) values (i, NULL, id_tuyenkenh, NULL, ngaydenghibangiao_, ngayhenbangiao_, thongtinlienhe_, 0, soluong_);    str := '<root><element><id>'||i||'</id></element></root>';    PROC_INSERT_LICHSU_TUYENKENH(usercreate_,id_tuyenkenh,6,str);  end if;  return i;END SAVE_TUYENKENHDEXUAT;/