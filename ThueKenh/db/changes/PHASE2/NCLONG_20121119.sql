----------------------------------------------------------  DDL for Function BC_CHUABANGIAO--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."BC_CHUABANGIAO" (doitac_id_ in varchar2) RETURN SYS_REFCURSOR ASl_cursor SYS_REFCURSOR;v_vcsql VARCHAR2(2000);v_vcsqlwhere VARCHAR2(1000);BEGIN	v_vcsqlwhere := ' t.DELETED = 0 and t.TRANGTHAI = 0 ';	if(doitac_id_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t1.DOITAC_ID = '||doitac_id_||' ';	end if;	v_vcsql := 'select t1.*,t3.LOAIGIAOTIEP,t.NGAYDENGHIBANGIAO,t.NGAYHENBANGIAO,t.SOLUONG as SOLUONGDEXUAT,t.TIENDO,TENDOITAC from TUYENKENHDEXUAT t left join TUYENKENH t1 on t.TUYENKENH_ID = t1.ID left join DOITAC t2 on t1.DOITAC_ID = t2.ID left join LOAIGIAOTIEP t3 on t1.GIAOTIEP_ID = t3.ID WHERE ' || v_vcsqlwhere || ' order by t.ID desc';	OPEN l_cursor FOR v_vcsql;	RETURN l_cursor;END BC_CHUABANGIAO;/----------------------------------------------------------  DDL for Function BC_CHUAHOPDONG--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."BC_CHUAHOPDONG" (doitac_id_ in varchar2) RETURN SYS_REFCURSOR AS/*Bao cao doi tac da ban giao kenh nhung chua co hop dong*/l_cursor SYS_REFCURSOR;v_vcsql VARCHAR2(2000);v_vcsqlwhere VARCHAR2(1000);BEGIN	v_vcsqlwhere := ' t.DELETED = 0 and t.BANGIAO_ID is not null and t.FLAG = 0 ';	if(doitac_id_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t1.DOITAC_ID = '||doitac_id_||' ';	end if;	v_vcsql := 'select t1.*,t4.LOAIGIAOTIEP,t.NGAYDENGHIBANGIAO,t.NGAYHENBANGIAO,t.SOLUONG as SOLUONGDEXUAT,t2.SOBIENBAN,t2.NGAYBANGIAO,t3.TENDOITAC from TUYENKENHDEXUAT t left join TUYENKENH t1 on t.TUYENKENH_ID = t1.ID left join BANGIAO t2 on t2.ID = t.BANGIAO_ID left join DOITAC t3 on t1.DOITAC_ID = t3.ID left join LOAIGIAOTIEP t4 on t1.GIAOTIEP_ID = t4.ID WHERE ' || v_vcsqlwhere || ' order by t.ID desc';	OPEN l_cursor FOR v_vcsql;	RETURN l_cursor;END BC_CHUAHOPDONG;/----------------------------------------------------------  DDL for Function BC_DOISOATCUOC--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."BC_DOISOATCUOC" (pDoiSoatCuocId in varchar2) RETURN SYS_REFCURSOR ASl_cursor SYS_REFCURSOR;BEGIN	OPEN l_cursor FOR select t.*,t1.tenphuluc,t1.soluongkenh,t1.giatritruocthue,t1.hopdong_id,t2.sohopdong from doisoatcuoc_phuluc t left join phuluc t1 on t.phuluc_id = t1.id left join hopdong t2 on t1.hopdong_id = t2.id	 where t.doisoatcuoc_id = pDoiSoatCuocId order by t1.hopdong_id;	RETURN l_cursor;END BC_DOISOATCUOC;/----------------------------------------------------------  DDL for Function BC_GIAMTRUMLL--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."BC_GIAMTRUMLL" (pDoiTacId in varchar2,pFrom in number,pEnd in number) RETURN SYS_REFCURSOR ASl_cursor SYS_REFCURSOR;BEGIN	OPEN l_cursor FOR select t3.*,t.*,loaigiaotiep,t1.giatritruocthue,t1.tenphuluc,t2.sohopdong 		from sucokenh t left join 			phuluc t1 on t.phuluc_id = t1.id left join 			hopdong t2 on t1.hopdong_id = t2.id left join 			tuyenkenh t3 on t.tuyenkenh_id = t3.id left join 			loaigiaotiep t4 on t3.giaotiep_id = t4.id 			where t.phuluc_id is not null and t.thoidiembatdau >= pFrom and t.thoidiembatdau < pEnd and t3.doitac_id = pDoiTacId;	RETURN l_cursor;END BC_GIAMTRUMLL;/----------------------------------------------------------  DDL for Function BC_HDCHUATHANHTOAN--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."BC_HDCHUATHANHTOAN" (pDoiTacId in varchar2,pPrevious in date,pCurrent in date) RETURN SYS_REFCURSOR ASl_cursor SYS_REFCURSOR;v_vcsql VARCHAR2(2000);v_vcsqlwhere VARCHAR2(1000);vThang number;vNam number;BEGIN	vThang := extract(month from pPrevious);	vNam := extract(year from pPrevious);	OPEN l_cursor FOR select t.*,sohopdong as tenhopdong from PHULUC t left join HOPDONG t1 on t.hopdong_id = t1.id where t1.deleted =0 and t.deleted = 0 and t.trangthai != 1 and (t.thang is null or t.thang < vThang) and (t.nam is null or t.nam = vNam) and (pDoiTacId is null or t1.doitac_id = pDoiTacId) and t.ngayhieuluc < pCurrent;	RETURN l_cursor;END BC_HDCHUATHANHTOAN;/----------------------------------------------------------  DDL for Function FN_SAVEDOISOATCUOC--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."FN_SAVEDOISOATCUOC" (doitac_id_ in varchar2,tungay_ in date,denngay_ in date,phulucs in TABLE_VARCHAR,sucos in TABLE_VARCHAR,timecreate_ in number)  RETURN SYS_REFCURSOR ASl_cursor SYS_REFCURSOR;-- Bien dung cho bang DOISOATCUOCvDoiSoatCuocId number;vDSCThanhTien number := 0;vGiamTruMLL number := 0;-- Bien dung cho bang DOISOATCUOC_PHULUC vSoNgay number;vTuNgay date;vDenNgay date;vThanhTien number;vDauNoiHoaMang number;vDaThanhToan number;vConThanhToan number;BEGIN  vDoiSoatCuocId := SEQ_DOISOATCUOC.nextval;	insert into DOISOATCUOC(ID,DOITAC_ID,TUNGAY,DENNGAY,TIMECREATE,DELETED) values (vDoiSoatCuocId,doitac_id_,tungay_,denngay_,timecreate_,timecreate_);	for rec in (select * from PHULUC where DELETED = 0 and ID in ((select * from table(phulucs)))) loop		if(rec.THANG is null) then -- phu luc ke khai thanh toan lan dau			vTuNgay := rec.NGAYHIEULUC;			vDauNoiHoaMang := rec.CUOCDAUNOI;		else			vTuNgay := tungay_;			vDauNoiHoaMang := 0;		end if;				if(rec.NGAYHETHIEULUC < denngay_) then			vDenNgay := rec.NGAYHETHIEULUC;		else			vDenNgay := denngay_;		end if;		vSoNgay := vDenNgay - vTuNgay;		vDaThanhToan := 0;		if(vSoNgay < 0) then -- lay lai so tien da thanh toan cho phu luc nay o thang truoc (do ky tre)			for recDSC_PL in (select t2.* from thanhtoan t left join doisoatcuoc t1 on t.doisoatcuoc_id = t1.id left join doisoatcuoc_phuluc t2 on t2.doisoatcuoc_id = t1.id where t2.phuluc_id = rec.ID and t1.tungay <= vDenNgay and t1.denngay >= vDenNgay order by t.TIMECREATE desc) loop				vSoNgay := vSoNgay + (recDSC_PL.SOTHANG * 30) + recDSC_PL.SONGAY;				vDaThanhToan := vDaThanhToan + recDSC_PL.CONTHANHTOAN;				vTuNgay := recDSC_PL.TUNGAY;			end loop;		end if;		vThanhTien := floor(rec.GIATRITRUOCTHUE / 30 * vSoNgay);		vConThanhToan := vThanhTien + vDauNoiHoaMang - vDaThanhToan;		insert into DOISOATCUOC_PHULUC(DOISOATCUOC_ID,PHULUC_ID,TUNGAY,DENNGAY,SOTHANG,SONGAY,THANHTIEN,DAUNOIHOAMANG,DATHANHTOAN,CONTHANHTOAN) values (vDoiSoatCuocId,rec.ID,vTuNgay,vDenNgay,floor(vSoNgay/30),MOD(vSoNgay,30),vThanhTien,vDauNoiHoaMang,vDaThanhToan,vConThanhToan);				vDSCThanhTien:= vDSCThanhTien + vThanhTien;	end loop;		--Tinh gia tri giam tru mat lien lac	for rec in (select * from SUCOKENH where DELETED = 0 and ID in ((select * from table(sucos)))) loop    insert into DOISOATCUOC_SUCO(DOISOATCUOC_ID,SUCO_ID) values (vDoiSoatCuocId,rec.ID);		vGiamTruMLL := vGiamTruMLL + rec.GIAMTRUMLL;	end loop;		-- Cap nhat lai bang doi soat cuoc	update DOISOATCUOC SET GIAMTRUMLL = vGiamTruMLL, THANHTIEN = vDSCThanhTien where ID = vDoiSoatCuocId;  open l_cursor for select vDoiSoatCuocId as ID,vDSCThanhTien as THANHTIEN,vGiamTruMLL as GIAMTRUMLL from dual;  return l_cursor;END FN_SAVEDOISOATCUOC;/