----------------------------------------------------------  DDL for Procedure PROC_UPDATE_TIEN_DO--------------------------------------------------------set define off;  CREATE OR REPLACE PROCEDURE "THUEKENH"."PROC_UPDATE_TIEN_DO" (tuyenkenh_dexuat_id in number,arr_tieuchuan_id in TABLE_VARCHAR,username_ in varchar2,createtime_ in varchar2)ASiTemp number:=0;iCount number := 0;tong_tieu_chuan number := 0;chua_dat number := 0;iDexuat number;tiendo_ number;iTuyenKenhDeXuatChuaBanGiao number;i number;tuyenkenh_id_ varchar2(50) := null;str varchar2(500) := '';begin	select TUYENKENH_ID into tuyenkenh_id_  from TUYENKENHDEXUAT where DELETED=0 and ID = tuyenkenh_dexuat_id;	if(tuyenkenh_id_ is not null) then		--lay cac tieu chuan da dat dc		DELETE from TUYENKENH_TIEUCHUAN where TUYENKENHDEXUAT_ID = tuyenkenh_dexuat_id;		--neu cac tieu chuan ton` tai		if(arr_tieuchuan_id.count() > 0) then			for i in arr_tieuchuan_id.first .. arr_tieuchuan_id.last loop				--them tieu chuan da dat dc				INSERT INTO TUYENKENH_TIEUCHUAN (TUYENKENHDEXUAT_ID, TIEUCHUAN_ID, USERCREATE, TIMECREATE, DELETED) 				VALUES (tuyenkenh_dexuat_id, arr_tieuchuan_id(i), username_, createtime_, '0');				select count(*) into iTemp from tieuchuan where id=arr_tieuchuan_id(i) and loaitieuchuan=1;				iCount := iCount + iTemp;				iTemp:=0;			end loop;		end if;				select count(*) into tong_tieu_chuan  from tieuchuan where deleted=0 and loaitieuchuan=1;		select count(*) into chua_dat  from tieuchuan where deleted=0 and loaitieuchuan = 1 and id not in (select * from table(arr_tieuchuan_id));		if(chua_dat = 0) then			update tuyenkenhdexuat set TIENDO = 100,trangthai=1 where id=tuyenkenh_dexuat_id;      -- send mail/sms      SEND_SMS(tuyenkenh_id_,3,null);      SEND_EMAIL(tuyenkenh_id_,3,null);			select dexuat_id into iDexuat from tuyenkenhdexuat where id=tuyenkenh_dexuat_id and deleted=0;			if(iDexuat is not null) then				select count(*) into iTuyenKenhDeXuatChuaBanGiao  from tuyenkenhdexuat where dexuat_id=iDexuat and trangthai!=1 and  deleted=0;				if(iTuyenKenhDeXuatChuaBanGiao = 0) then					update dexuat set trangthai=1 where id=iDexuat;				end if;			end if;		else			if(tong_tieu_chuan = 0) then				tiendo_ := 0;				update tuyenkenhdexuat set TIENDO = tiendo_ where id=tuyenkenh_dexuat_id;			else				tiendo_ := round(iCount/tong_tieu_chuan*100,2);			update tuyenkenhdexuat set TIENDO = tiendo_,trangthai=0 where id=tuyenkenh_dexuat_id;			end if;		end if;				--update history tuyenkenh    str := '<root><element><id>'||tuyenkenh_dexuat_id||'</id></element></root>';		PROC_INSERT_LICHSU_TUYENKENH(username_,tuyenkenh_id_,9,str);	end if;end PROC_UPDATE_TIEN_DO;/