CREATE SEQUENCE SEQ_HOPDONG INCREMENT BY 1 START WITH 1 MAXVALUE 99999 MINVALUE 1;----------------------------------------------------------  DDL for Function FIND_HOPDONG--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."FIND_HOPDONG" (iDisplayStart IN NUMBER,   iDisplayLength IN NUMBER, doitac_id_ in varchar2,sohopdong_ in varchar2,loaihopdong_ in varchar2,ngayky_ in varchar2,ngayhethan_ in varchar2) RETURN SYS_REFCURSOR ASl_cursor SYS_REFCURSOR;v_vcsql VARCHAR2(2000);v_vcsqlwhere VARCHAR2(1000);i NUMBER;BEGIN	v_vcsqlwhere := ' t.DELETED = 0 ';	if(doitac_id_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.DOITAC_ID = '||doitac_id_||' ';	end if;	if(sohopdong_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.SOHOPDONG like ''%'||sohopdong_||'%'' ';	end if;	if(loaihopdong_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.LOAIHOPDONG = '||loaihopdong_||' ';	end if;	if(ngayky_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.NGAYKY = TO_DATE('''||ngayky_||''',''DD-MM-RRRR'') ';	end if;	if(ngayhethan_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.NGAYHETHAN = TO_DATE('''||ngayhethan_||''',''DD-MM-RRRR'') ';	end if;	v_vcsql := 'select rownum as rn,dulieu.* from (SELECT t.*,t0.TENDOITAC FROM HOPDONG t left join DOITAC t0 on t.DOITAC_ID = t0.ID WHERE ' || v_vcsqlwhere || ' order by t.ID desc) dulieu ';	v_vcsql := 'SELECT * FROM (' || v_vcsql || ') WHERE rn > ' || iDisplayStart || ' and rn <= ' || (iDisplayStart+iDisplayLength);	--dbms_output.put_line(v_vcsql); --test(v_vcsql);	OPEN l_cursor FOR v_vcsql;	RETURN l_cursor;END FIND_HOPDONG;/----------------------------------------------------------  DDL for Function SAVE_HOPDONG--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."SAVE_HOPDONG" (id_ in VARCHAR2,doitac_id_ in VARCHAR2,sohopdong_ in VARCHAR2,loaihopdong_ in VARCHAR2,ngayky_ in VARCHAR2,ngayhethan_ in VARCHAR2,usercreate_ in VARCHAR2,timecreate_ in VARCHAR2,history_ in VARCHAR2) RETURN NUMBER ASi INTEGER := 0;BEGIN	if(id_ is not null) then --update		update HOPDONG set DOITAC_ID = doitac_id_,SOHOPDONG = sohopdong_,LOAIHOPDONG = loaihopdong_,NGAYKY = ngayky_,NGAYHETHAN = ngayhethan_,HISTORY = history_ where ID = id_;		i := id_;	else --insert		i:=SEQ_HOPDONG.nextval;				insert into HOPDONG(ID,DOITAC_ID,SOHOPDONG,LOAIHOPDONG,NGAYKY,NGAYHETHAN,TRANGTHAI,USERCREATE,TIMECREATE,HISTORY,DELETED) values (i, doitac_id_, sohopdong_, loaihopdong_, ngayky_, ngayhethan_,0, usercreate_, timecreate_, history_,0);	end if;	return i;END SAVE_HOPDONG;/ALTER TABLE CHITIETPHULUC ADD (SOLUONGKENH VARCHAR2(200) DEFAULT 0 );CREATE SEQUENCE SEQ_PHULUC INCREMENT BY 1 START WITH 1 MAXVALUE 99999 MINVALUE 1;----------------------------------------------------------  DDL for Function FIND_PHULUC--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."FIND_PHULUC" (iDisplayStart IN NUMBER,   iDisplayLength IN NUMBER, tenhopdong_ in varchar2,tenphuluc_ in varchar2,loaiphuluc_ in varchar2,ngayky_ in varchar2,ngayhieuluc_ in varchar2) RETURN SYS_REFCURSOR ASl_cursor SYS_REFCURSOR;v_vcsql VARCHAR2(2000);v_vcsqlwhere VARCHAR2(1000);i NUMBER;BEGIN	v_vcsqlwhere := ' t.DELETED = 0 ';	if(tenhopdong_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t0.SOHOPDONG like ''%'||tenhopdong_||'%'' ';	end if;	if(tenphuluc_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.TENPHULUC like ''%'||tenphuluc_||'%'' ';	end if;	if(loaiphuluc_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.LOAIPHULUC = '||loaiphuluc_||' ';	end if;	if(ngayky_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.NGAYKY = TO_DATE('''||ngayky_||''',''DD-MM-RRRR'') ';	end if;	if(ngayhieuluc_ is not null) then		v_vcsqlwhere := v_vcsqlwhere ||' and t.NGAYHIEULUC = TO_DATE('''||ngayhieuluc_||''',''DD-MM-RRRR'') ';	end if;	v_vcsql := 'select rownum as rn,dulieu.* from (SELECT t.*,t0.LOAIHOPDONG,t0.DOITAC_ID,t2.TENDOITAC,t1.CUOCDAUNOI,t1.GIATRITRUOCTHUE,t1.GIATRISAUTHUE,t1.SOLUONGKENH FROM PHULUC t 		left join HOPDONG t0 on t.HOPDONG_ID = t0.ID 		left join CHITIETPHULUC t1 on t.CHITIETPHULUC_ID = t1.ID 		left join DOITAC t2 on t0.DOITAC_ID = t2.ID  WHERE ' || v_vcsqlwhere || ' order by t.ID desc) dulieu ';	v_vcsql := 'SELECT * FROM (' || v_vcsql || ') WHERE rn > ' || iDisplayStart || ' and rn <= ' || (iDisplayStart+iDisplayLength);	--dbms_output.put_line(v_vcsql); --test(v_vcsql);	OPEN l_cursor FOR v_vcsql;	RETURN l_cursor;END FIND_PHULUC;/----------------------------------------------------------  DDL for Function SAVE_PHULUC--------------------------------------------------------  CREATE OR REPLACE FUNCTION "THUEKENH"."SAVE_PHULUC" (id_ in VARCHAR2,chitietphuluc_id_ in VARCHAR2,hopdong_id_ in VARCHAR2,tenphuluc_ in VARCHAR2,loaiphuluc_ in VARCHAR2,ngayky_ in VARCHAR2,ngayhieuluc_ in VARCHAR2,usercreate_ in VARCHAR2,timecreate_ in VARCHAR2,filename_ in VARCHAR2,filepath_ in VARCHAR2,filesize_ in VARCHAR2) RETURN NUMBER ASi INTEGER := 0;ngayhethan_ DATE := null;BEGIN	select NGAYHETHAN into ngayhethan_ from HOPDONG where ID = hopdong_id_;	if(id_ is not null) then --update		update PHULUC set CHITIETPHULUC_ID = chitietphuluc_id_,HOPDONG_ID = hopdong_id_,TENPHULUC = tenphuluc_,LOAIPHULUC = loaiphuluc_,NGAYKY = ngayky_,NGAYHIEULUC = ngayhieuluc_,NGAYHETHIEULUC = ngayhethan_,FILENAME = filename_,FILEPATH = filepath_,FILESIZE = filesize_ where ID = id_;		i := id_;	else --insert		i:=SEQ_PHULUC.nextval;				insert into PHULUC(ID,CHITIETPHULUC_ID,HOPDONG_ID,TENPHULUC,LOAIPHULUC,NGAYKY,NGAYHIEULUC,THANG,NAM,TRANGTHAI,USERCREATE,TIMECREATE,DELETED,NGAYHETHIEULUC,FILENAME,FILEPATH,FILESIZE,PHULUCTHAYTHE_ID) values (i,chitietphuluc_id_,hopdong_id_,tenphuluc_,loaiphuluc_,ngayky_,ngayhieuluc_,null,null,0,usercreate_,timecreate_,0,ngayhethan_,filename_,filepath_,filesize_,null);	end if;	return i;END SAVE_PHULUC;/