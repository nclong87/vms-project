ALTER TABLE DEXUAT 
ADD (TRANGTHAI NUMBER );


create or replace
function get_tiendo (
tuyenkenh_dexuat_id in number
)
return number as 
t1 NUMBER ;
t2 number;
begin
  select count(*) into t1  from tuyenkenh_tieuchuan tt,tieuchuan tc where tt.tieuchuan_id=tc.id and tc.loaitieuchuan=1 and tuyenkenhdexuat_id=tuyenkenh_dexuat_id and tt.deleted=0 and tc.deleted=0;
  select count(*) into t2  from tieuchuan where loaitieuchuan=1 and deleted=0;
  t1:=t1/t2;
  return t1*100;
end get_tiendo;


create or replace
FUNCTION            "FIND_TUYENKENHBANGIAO" (
iDisplayStart IN NUMBER,   
iDisplayLength IN NUMBER, 
makenh_ in varchar2,
loaigiaotiep_ in varchar2,
madiemdau_ in varchar2,
madiemcuoi_ in varchar2,
duan_ in varchar2,
ngaydenghibangiao_ in varchar2,
ngayhenbangiao_ in varchar2,
dexuat_id_ in varchar2,
username_ in varchar2
) RETURN SYS_REFCURSOR AS
l_cursor SYS_REFCURSOR;
v_vcsql VARCHAR2(2000);
v_vcsqlwhere VARCHAR2(1000);
i NUMBER;
BEGIN
	v_vcsqlwhere := ' t.DELETED = 0 and ac.username='''||username_||'''';
  if(dexuat_id_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and t.DEXUAT_ID = '||dexuat_id_||' ';
	end if;
	if(makenh_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and t0.ID = '||makenh_||' ';
	end if;
	if(loaigiaotiep_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and GIAOTIEP_ID = '||loaigiaotiep_||' ';
	end if;
	if(duan_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and t0.DUAN_ID = '||duan_||' ';
	end if;
	if(madiemdau_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and t0.MADIEMDAU like '''||replace(madiemdau_, '*', '%')||''' ';
	end if;
	if(madiemcuoi_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and t0.MADIEMCUOI like '''||replace(madiemcuoi_, '*', '%')||''' ';
	end if;
	if(ngaydenghibangiao_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and t.NGAYDENGHIBANGIAO = TO_DATE('''||ngaydenghibangiao_||''',''DD-MM-RRRR'') ';
	end if;
	if(ngayhenbangiao_ is not null) then
		v_vcsqlwhere := v_vcsqlwhere ||' and t.NGAYHENBANGIAO = TO_DATE('''||ngayhenbangiao_||''',''DD-MM-RRRR'') ';
	end if;
	v_vcsql := 'select rownum as rn,dulieu.* from (
              SELECT t.ID as ID,t0.ID as TUYENKENH_ID,MADIEMDAU,MADIEMCUOI,t1.LOAIGIAOTIEP,t0.DUNGLUONG,t.SOLUONG,dx.tenvanban as tenvanbandexuat,t2.tenduan,get_tiendo(t.id) as tiendo,dx.id as MAVANBANDEXUAT
              FROM TUYENKENHDEXUAT t 
              left join TUYENKENH t0 on t.TUYENKENH_ID = t0.ID 
              left join LOAIGIAOTIEP t1 on t0.GIAOTIEP_ID = t1.ID 
              left join DUAN t2 on t0.DUAN_ID = t2.ID 
              left join PHONGBAN t3 on t0.PHONGBAN_ID = t3.ID 
              left join KHUVUC t4 on t0.KHUVUC_ID=t4.ID
              left join accounts ac on ac.idkhuvuc = t4.id
              left join dexuat dx on dx.id=t.dexuat_id
              where  t.trangthai=0 and dx.trangthai=0 and '|| v_vcsqlwhere || ' order by t0.ID desc) dulieu ';
	v_vcsql := 'SELECT * FROM (' || v_vcsql || ') WHERE rn >= ' || iDisplayStart || ' and rn <= ' || (iDisplayStart+iDisplayLength);
	--dbms_output.put_line(v_vcsql);
-- test(v_vcsql);
	OPEN l_cursor FOR v_vcsql;
	RETURN l_cursor;
END FIND_TUYENKENHBANGIAO;


